---
AWSTemplateFormatVersion: "2010-09-09"
Description: "This creates a VPC, Public Subnets and Private Subnets, EKS cluster, and sets up Discngine 3decision infrastructure. (qs-1snm79fes)."
Metadata:
  QuickStartDocumentation:
    EntrypointName: "Parameters for launching into a new VPC"
  LintSpellExclude:
    - Discngine
    - 3decision
    - namespace
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Network configuration"
        Parameters:
          - VPCCIDR
          - PublicSubnet1CIDR
          - PublicSubnet2CIDR
          - PublicSubnet3CIDR
          - PrivateSubnet1CIDR
          - PrivateSubnet2CIDR
          - PrivateSubnet3CIDR
          - RemoteAccessCIDR
      - Label:
          default: Amazon EC2 configuration
        Parameters:
          - KeyPairName
      - Label:
          default: Amazon EKS configuration
        Parameters:
          - ConfigSetName
          - NodeVolumeSize
          - NodeInstanceType
          - NumberOfNodes
          - AdditionalEKSAdminUserArn
          - AdditionalEKSAdminRoleArn
          - ProvisionBastionHost
      - Label:
          default: Discngine 3decision network configuration
        Parameters:
          - DomainName
          - HostedZoneId
          - CertificateArn
          - TdecRecordName
          - EtlRecordName
          - LoadBalancerType
      - Label:
          default : Discngine 3decision database configuration
        Parameters:
          - DBInstanceIdentifier
          - DBName
          - DBPassword
          - DBInstanceClass
          - DBMultiZone
      - Label:
          default: Discngine 3decision Kubernetes configuration
        Parameters:
          - EtlUser
          - EtlPassword
          - TNamespace
          - JWTPrivateKey
          - JWTPublicKey
          - JWTKeysSecretName
      - Label:
          default: AWS Quick Start configuration
        Parameters:
          - QSS3BucketName
          - QSS3BucketRegion
          - QSS3KeyPrefix
          - PerAccountSharedResources
          - PerRegionSharedResources
    ParameterLabels:
      KeyPairName:
        default: SSH key name
      PrivateSubnet1CIDR:
        default: Private subnet 1 CIDR
      PrivateSubnet2CIDR:
        default: Private subnet 2 CIDR
      PrivateSubnet3CIDR:
        default: Private subnet 3 CIDR
      PublicSubnet1CIDR:
        default: Public subnet 1 CIDR
      PublicSubnet2CIDR:
        default: Public subnet 2 CIDR
      PublicSubnet3CIDR:
        default: Public subnet 3 CIDR
      QSS3BucketName:
        default: Quick Start S3 bucket name
      QSS3BucketRegion:
        default: Quick Start S3 bucket region
      QSS3KeyPrefix:
        default: Quick Start S3 key prefix
      RemoteAccessCIDR:
        default: Allowed external access CIDR
      VPCCIDR:
        default: VPC CIDR
      PerAccountSharedResources:
        default: Per account shared resources
      PerRegionSharedResources:
        default: Per region shared resources
      NodeInstanceType:
        default: Node instance type
      NumberOfNodes:
        default: Number of nodes
      AdditionalEKSAdminUserArn:
        default: Additional Amazon EKS administrator ARN (IAM user)
      AdditionalEKSAdminRoleArn:
        default: Additional Amazon EKS administrator ARN (IAM role)
      ConfigSetName:
        default: Config set name
      NodeVolumeSize:
        default: Size of worker nodes volumes
      DBInstanceIdentifier:
        default: Identifier of the database
      DBName:
        default: Name of the database
      DBPassword:
        default: Password of the database
      DBInstanceClass:
        default: Instance type of the database
      DBMultiZone:
        default: Database highly available
      TNamespace:
        default: 3decision Helm chart namespace
      JWTPrivateKey:
        default: Private SSH key in base 64 used for JWT
      JWTPublicKey:
        default: Public SSH key in base 64 used for JWT
      EtlUser:
        default: Username used for ETL
      EtlPassword:
        default: Password used for ETL
      HostedZoneId:
        default: Route 53 hosted zone ID
      DomainName:
        default: Domain name used for load balancing
      CertificateArn:
        default: ARN of a certificate
      TdecRecordName:
        default: Record name of main 3decision page
      EtlRecordName:
        default: Record name of ETL page
      LoadBalancerType:
        default: Type of load balancer created
      ProvisionBastionHost:
        default: Provision a bastion host
Parameters:
  KeyPairName:
    Description: A public/private key pair, which allows you to connect securely to your instance after it launches.
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: Must be an existing key name.
  NodeInstanceType:
    Type: String
    Default: t3.xlarge
    Description: Amazon EKS node instance type. We recommend that you use t3.xlarge, the minimum required node shape.
    AllowedValues:
      - t3.xlarge
      - t3.2xlarge
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.12xlarge
      - m5.24xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5.9xlarge
      - c5.18xlarge
      - i3.large
      - i3.xlarge
      - i3.2xlarge
      - i3.4xlarge
      - i3.8xlarge
      - i3.16xlarge
      - x1.16xlarge
      - x1.32xlarge
      - p3.2xlarge
      - p3.8xlarge
      - p3.16xlarge
      - r5.large
      - r5.xlarge
      - r5.2xlarge
      - r5.4xlarge
      - r5.12xlarge
      - r5.24xlarge
      - r5d.large
      - r5d.xlarge
      - r5d.2xlarge
      - r5d.4xlarge
      - r5d.12xlarge
      - r5d.24xlarge
      - z1d.large
      - z1d.xlarge
      - z1d.2xlarge
      - z1d.3xlarge
      - z1d.6xlarge
      - z1d.12xlarge
  VPCCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28.
    Default: 10.0.0.0/16
    Description: The CIDR block for the VPC.
    Type: String
  PublicSubnet1CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28.
    Default: 10.0.128.0/20
    Description: The CIDR block used for the public subnet, located in Availability Zone 1.
    Type: String
  PublicSubnet2CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28.
    Default: 10.0.144.0/20
    Description: The CIDR block used for the public subnet, located in Availability Zone 2.
    Type: String
  PublicSubnet3CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28.
    Default: 10.0.160.0/20
    Description: The CIDR block for the public (DMZ) subnet 3, located in Availability Zone 3.
    Type: String
  PrivateSubnet1CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28.
    Default: 10.0.0.0/19
    Description: The CIDR block used for the private subnet, located in Availability Zone 1.
    Type: String
  PrivateSubnet2CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.32.0/19
    Description: The CIDR block used for the private subnet, located in Availability Zone 2.
    Type: String
  PrivateSubnet3CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.64.0/19
    Description: The CIDR block for private subnet 3, located in Availability Zone 3.
    Type: String
  QSS3BucketName:
    AllowedPattern: '^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$'
    ConstraintDescription:
      The Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a 
      hyphen (-).
    Default: aws-quickstart
    Description:
      Name of the S3 bucket for your copy of the Quick Start assets. 
      Keep the default name unless you are customizing the template. 
      Changing the name updates code references to point to a new Quick 
      Start location. This name can include numbers, lowercase letters, 
      uppercase letters, and hyphens, but do not start or end with a hyphen (-). 
      See https://aws-quickstart.github.io/option1.html.
    Type: String
  QSS3BucketRegion:
    Default: 'us-east-1'
    Description: 'AWS Region where the Quick Start S3 bucket (QSS3BucketName) is 
    hosted. Keep the default Region unless you are customizing the template. 
    Changing this Region updates code references to point to a new Quick Start location. 
    When using your own bucket, specify the Region. 
    See https://aws-quickstart.github.io/option1.html.'
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: '^[0-9a-zA-Z-/]*$'
    ConstraintDescription:
      The Quick Start S3 key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slashes (/). The prefix should
      end with a forward slash (/).
    Default: quickstart-discngine-3decision/
    Description:
      S3 key prefix that is used to simulate a folder for your copy of the 
      Quick Start assets. Keep the default prefix unless you are customizing 
      the template. Changing this prefix updates code references to point to 
      a new Quick Start location. This prefix can include numbers, lowercase 
      letters, uppercase letters, hyphens (-), and forward slashes (/). End with 
      a forward slash. See https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingMetadata.html 
      and https://aws-quickstart.github.io/option1.html.
    Type: String
  RemoteAccessCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/x
    Description: The CIDR IP range that is permitted to access the instances. We recommend
      that you set this value to a trusted IP range.
    Default: "127.0.0.1/32"
    Type: String
  ConfigSetName:
    Type: String
    Default: "dng-3decision"
    Description: Name used to map advanced parameters to an Amazon EKS cluster. Leave blank to create Amazon EKS default parameters.
  NodeVolumeSize:
    Type: String
    Default: 100
    Description: Size of EBS volumes attached to worker nodes.
                  Increase this size if your pods are getting evicted with a disk pressure annotation.
  PerAccountSharedResources:
    Type: String
    AllowedValues: ['AutoDetect', 'Yes', 'No']
    Default: 'AutoDetect'
    Description: Choose "No" if you already deployed another Amazon EKS Quick Start stack in your AWS account.
  PerRegionSharedResources:
    Type: String
    AllowedValues: ['AutoDetect', 'Yes', 'No']
    Default: 'AutoDetect'
    Description: Choose "No" if you already deployed another Amazon EKS Quick Start stack in your Region.
  NumberOfNodes:
    Default: 3
    Description: The number of Amazon EKS node instances. The default is one for each of the three Availability Zones.
    Type: Number
  DBInstanceIdentifier:
    Default: db3dec
    Description: Database instance name. The default is db3dec.
    Type: String
    MinLength: '1'
    MaxLength: '8'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters.
  DBName:
    Default: ORCL
    Description: Amazon RDS Oracle database name. The default is ORCL.
    Type: String
    MinLength: '1'
    MaxLength: '8'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters.
  DBPassword:
    NoEcho: true
    Description: Database administrator account password.
    Type: String
    MinLength: '8'
    MaxLength: '41'
  DBInstanceClass:
    AllowedValues:
      - db.t3.micro
      - db.t3.small
      - db.t3.medium
      - db.t3.large
      - db.t3.xlarge
      - db.t3.2xlarge
      - db.m5.large
      - db.m5.xlarge
      - db.m5.2xlarge
      - db.m5.4xlarge
    Default: db.t3.xlarge
    Description: Amazon RDS instance type for the Oracle Database instance.
                 We recommend t3.xlarge for production use as a lower shape will be rather slow.
    Type: String
  DBMultiZone:
    Description: High Availability (Multi-AZ) for Oracle RDS. For more information, refer to https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.MultiAZ.html.
    Type: String
    AllowedValues: [ 'true', 'false' ]
    Default: 'false'
  TNamespace:
    Default: tdecision
    Description: Name of the Kubernetes namespace in which the 3decision helm chart will be deployed. This default to tdecision. The namespace will be created if it doesn't already exist.
    Type: String
  JWTKeysSecretName:
    Default: ""
    Description: Name of a secret in SecretsManager containing base64 keys in fields private_key and public_key. If used, you must disable wrapping and paste the base64 encoded strings that retrieve by running 'base64 -w0 id_rsa' and 'base64 -w0 id_rsa.pub'. By default, this will have no value, in which case the variables JWTPrivateKey and JWTPublicKey are used.
    Type: String
  JWTPrivateKey:
    Default: ""
    Description: SSH private key in base64 format. You must disable wrapping and paste the base64 encoded string that you can retrieve by running 'base64 -w0 id_rsa'. If JWTKeysSecretName is set, this variable is not used.
    Type: String
    NoEcho: true
  JWTPublicKey:
    Default: ""
    Description: SSH public key in base64 format. You must disable wrapping and paste the base64 encoded string that you can retrieve by running 'base64 -w0 id_rsa.pub'. If JWTKeysSecretName is set, this variable is not used.
    Type: String
  EtlUser:
    Default: "3decision"
    Description: 3decision username.
    Type: String
  EtlPassword:
    Description: 3decision password.
    Type: String
    NoEcho: true
  AdditionalEKSAdminUserArn:
    Default: ""
    Description: "(Optional) IAM user Amazon Resource Name (ARN) to be granted administrative access to the Amazon EKS cluster."
    Type: String
  AdditionalEKSAdminRoleArn:
    Default: ""
    Description: "(Optional) IAM role Amazon Resource Name (ARN) to be granted administrative access to the Amazon EKS cluster."
    Type: String
  HostedZoneId:
    Default: ""
    Description: (Optional) Creates DNS records for the Route 53 hosted zone.
    Type: String
  DomainName:
    Description: Root domain name used for load balancer rules. This is only the root domain name, not the FQDN (e.g., example.com).
    Type: String
  CertificateArn:
    Default: ""
    Description: (Optional) ARN of a certificate of the associated domain you want added to the load balancer.
    Type: String
  TdecRecordName:
    Default: "3decision"
    Description: Subpath of the main 3decision page. Will add route to hostedZone if given as recordName.domainName.
    Type: String
  EtlRecordName:
    Default: "3decision-etl"
    Description: Subpath of the 3decision ETL page. Will add route to hostedZone if given as recordName.domainName.
    Type: String
  LoadBalancerType:
    AllowedValues:
      - internet-facing
      - internal
    Default: "internet-facing"
    Description: Type of load balancer created. This can either be internet-facing for a public load balancer or internal for private load balancers.
    Type: String
  ProvisionBastionHost:
    Type: String
    AllowedValues: [ "Enabled", "Disabled" ]
    Default: "Disabled"
    Description: Choose Enabled to create a bastion host. This can be used to debug Amazon EKS nodes.

Rules:
  DiscngineSupportedRegionRule:
    Assertions:
      - Assert:
          Fn::Contains:
            - - us-east-1
              - eu-central-1
            - !Ref AWS::Region
        AssertDescription: The Quick Start is supported only in us-east-1 and eu-central-1 AWS Regions. Please contact Discngine to request support for other Regions.

Conditions:
  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, 'aws-quickstart']
Resources:
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::Sub:
          - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/quickstart-aws-vpc/templates/aws-vpc.template.yaml'
          - S3Region: !If
              - UsingDefaultBucket
              - !Ref AWS::Region
              - !Ref QSS3BucketRegion
            S3Bucket: !If
              - UsingDefaultBucket
              - !Sub '${QSS3BucketName}-${AWS::Region}'
              - !Ref QSS3BucketName
      Parameters:
        AvailabilityZones: !Join [',', Fn::GetAZs: !Ref 'AWS::Region']
        NumberOfAZs: '3'
        VPCCIDR: !Ref VPCCIDR
        PrivateSubnet1ACIDR: !Ref PrivateSubnet1CIDR
        PrivateSubnet2ACIDR: !Ref PrivateSubnet2CIDR
        PrivateSubnet3ACIDR: !Ref PrivateSubnet3CIDR
        PublicSubnet1CIDR: !Ref PublicSubnet1CIDR
        PublicSubnet2CIDR: !Ref PublicSubnet2CIDR
        PublicSubnet3CIDR: !Ref PublicSubnet3CIDR
        PrivateSubnetATag2: "kubernetes.io/role/internal-elb="
        PublicSubnetTag2: "kubernetes.io/role/elb="
  3decisionEKSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/discngine-3decision-existing-vpc.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        PublicSubnet1ID: !GetAtt VPCStack.Outputs.PublicSubnet1ID
        PublicSubnet2ID: !GetAtt VPCStack.Outputs.PublicSubnet2ID
        PublicSubnet3ID: !GetAtt VPCStack.Outputs.PublicSubnet3ID
        PrivateSubnet1ID: !GetAtt VPCStack.Outputs.PrivateSubnet1AID
        PrivateSubnet2ID: !GetAtt VPCStack.Outputs.PrivateSubnet2AID
        PrivateSubnet3ID: !GetAtt VPCStack.Outputs.PrivateSubnet3AID
        DBInstanceIdentifier: !Ref DBInstanceIdentifier
        DBName: !Ref DBName
        DBPassword: !Ref DBPassword
        DBInstanceClass: !Ref DBInstanceClass
        DBMultiZone: !Ref DBMultiZone
        TNamespace: !Ref TNamespace
        JWTKeysSecretName: !Ref JWTKeysSecretName
        JWTPrivateKey: !Ref JWTPrivateKey
        JWTPublicKey: !Ref JWTPublicKey
        HostedZoneId: !Ref HostedZoneId
        DomainName: !Ref DomainName
        CertificateArn: !Ref CertificateArn
        KeyPairName: !Ref KeyPairName
        NumberOfNodes: !Ref NumberOfNodes
        ConfigSetName: !Ref ConfigSetName
        NodeInstanceType: !Ref NodeInstanceType
        RemoteAccessCIDR: !Ref RemoteAccessCIDR
        PerAccountSharedResources: !Ref PerAccountSharedResources
        PerRegionSharedResources: !Ref PerRegionSharedResources
        AdditionalEKSAdminUserArn: !Ref AdditionalEKSAdminUserArn
        AdditionalEKSAdminRoleArn: !Ref AdditionalEKSAdminRoleArn
        NodeVolumeSize: !Ref NodeVolumeSize
        EtlUser: !Ref EtlUser
        EtlPassword: !Ref EtlPassword
        TdecRecordName: !Ref TdecRecordName
        EtlRecordName: !Ref EtlRecordName
        LoadBalancerType: !Ref LoadBalancerType
        ProvisionBastionHost: !Ref ProvisionBastionHost
