---
AWSTemplateFormatVersion: 2010-09-09
Description: "This template sets up Discngine 3decision infrastructure. (qs-1s40771km)."
Metadata:
  QuickStartDocumentation:
    EntrypointName: "Launch into an existing EKS cluster"
  LintSpellExclude:
    - Discngine
    - 3decision
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: AWS Quick Start configuration
        Parameters:
          - QSS3BucketName
          - QSS3BucketRegion
          - QSS3KeyPrefix
      - Label:
          default: "Discngine 3decision dns configuration"
        Parameters:
          - HostedZoneId
          - HostedZoneName
      - Label:
          default: "Discngine 3decision kube configuration"
        Parameters:
          - TNamespace
          - RegistrySecretName
          - JWTSecretName
          - JWTPrivateKey
          - JWTPublicKey
          - EKSClusterName
    ParameterLabels:
      QSS3BucketName:
        default: Quick Start S3 bucket name
      QSS3BucketRegion:
        default: Quick Start S3 bucket region
      QSS3KeyPrefix:
        default: Quick Start S3 key prefix
      HostedZoneId:
        default: Sample Param
      HostedZoneName:
        default: Sample Param
      TNamespace:
        default: Sample Param
      RegistrySecretName:
        default: Sample Param
      JWTSecretName:
        default: Sample Param
      JWTPrivateKey:
        default: Sample Param
      JWTPublicKey:
        default: Sample Param
      EKSClusterName:
        default: Sample Param
Conditions:
  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, 'aws-quickstart']
Parameters:
  QSS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen
      (-).
    Default: aws-quickstart
    Description: S3 bucket name for the Quick Start assets. This string can include
      numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start
      or end with a hyphen (-).
    Type: String
  QSS3BucketRegion:
    Default: 'eu-central-1'
    Description: "The AWS Region where the Quick Start S3 bucket (QSS3BucketName) is hosted. When using your own bucket, you must specify this value."
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-/]*$
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slash (/).
    Default: quickstart-discngine-3decision/
    Description: S3 key prefix for the Quick Start assets. Quick Start key prefix
      can include numbers, lowercase letters, uppercase letters, hyphens (-), and
      forward slash (/).
    Type: String
  HostedZoneId:
    Default: AWS::NoValue
    Description: "The ID of the hosted zone that you want to create records in."
    Type: String
  HostedZoneName:
    Default: AWS::NoValue
    Description: "The Name of the hosted zone that you want to create records in."
    Type: String
  TNamespace:
    Default: tdecision
    Description: ""
    Type: String
  RegistrySecretName:
    Default: ociregistry
    Description: ""
    Type: String
  JWTSecretName:
    Default: 3decision-jwt-secret
    Description: ""
    Type: String
  JWTPrivateKey:
    Description: "An SSH private key in base64 format"
    Type: String
    NoEcho: true
  JWTPublicKey:
    Description: "An SSH public key in base64 format"
    Type: String
  EKSClusterName:
    Description: ""
    Type: String
  TMPServer:
    Type: String
    Default: fra.ocir.io
  TMPUsername:
    Type: String
    Default: idcs_federation/jonathan.manassen@discngine.com
  TMPPassword:
    Type: String

Resources:
  DNSRecord:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/discngine-3decision-dns.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        HostedZoneId: !Ref HostedZoneId
        HostedZoneName: !Ref HostedZoneName
  3decisionKubeStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: DNSRecord
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/discngine-3decision-kube.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        TNamespace: !Ref TNamespace
        RegistrySecretName: !Ref RegistrySecretName
        JWTSecretName: !Ref JWTSecretName
        JWTPrivateKey: !Ref JWTPrivateKey
        JWTPublicKey: !Ref JWTPublicKey
        EKSClusterName: !Ref EKSClusterName
        LoadBalancerEIP: !GetAtt DNSRecord.Outputs.LoadBalancerEIP
        TMPServer: !Ref TMPServer
        TMPUsername: !Ref TMPUsername
        TMPPassword: !Ref TMPPassword