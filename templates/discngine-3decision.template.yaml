---
AWSTemplateFormatVersion: 2010-09-09
Description: "This template sets up Discngine 3decision infrastructure. (qs-1s40771km)."
Metadata:
  QuickStartDocumentation:
    EntrypointName: "Launch into an existing EKS cluster"
  LintSpellExclude:
    - Discngine
    - 3decision
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Discngine 3decision dns configuration"
        Parameters:
          - HostedZoneId
          - HostedZoneName
      - Label:
          default: "Discngine 3decision kube configuration"
        Parameters:
          - TNamespace
          - RegistrySecretName
          - JWTSecretName
          - JWTPrivateKey
          - JWTPublicKey
          - EKSClusterName
    ParameterLabels:
      HostedZoneId:
        default: Sample Param
      HostedZoneName:
        default: Sample Param
      TNamespace:
        default: Sample Param
      RegistrySecretName:
        default: Sample Param
      JWTSecretName:
        default: Sample Param
      JWTPrivateKey:
        default: Sample Param
      JWTPublicKey:
        default: Sample Param
      EKSClusterName:
        default: Sample Param
Parameters:
  ### DNS PARAMETERS
  HostedZoneId:
    Default: AWS::NoValue
    Description: "The ID of the hosted zone that you want to create records in."
    Type: String
  HostedZoneName:
    Default: AWS::NoValue
    Description: "The Name of the hosted zone that you want to create records in."
    Type: String
  ### KUBE PARAMETERS
  TNamespace:
    Default: tdecision
    Description: ""
    Type: String
  RegistrySecretName:
    Default: ociregistry
    Description: ""
    Type: String
  JWTSecretName:
    Default: 3decision-jwt-secret
    Description: ""
    Type: String
  JWTPrivateKey:
    Description: "An SSH private key in base64 format"
    Type: String
    NoEcho: true
  JWTPublicKey:
    Description: "An SSH public key in base64 format"
    Type: String
  EKSClusterName:
    Description: ""
    Type: String
  TMPServer:
    Type: String
    Default: fra.ocir.io
  TMPUsername:
    Type: String
    Default: idcs_federation/jonathan.manassen@discngine.com
  TMPPassword:
    Type: String

Resources:
  DNSRecord:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/discngine-3decision-dns.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        HostedZoneId: !Ref HostedZoneId
        HostedZoneName: !Ref HostedZoneName
  3decisionKubeStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: DNSRecord
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/discngine-3decision-kube.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        TNamespace: !Ref TNamespace
        RegistrySecretName: !Ref RegistrySecretName
        RegistryServer: !Ref RegistryServer
        RegistryUsername: !Ref RegistryUsername
        RegistryPassword: !Ref RegistryPassword
        JWTSecretName: !Ref JWTSecretName
        JWTPrivateKey: !Ref JWTPrivateKey
        JWTPublicKey: !Ref JWTPublicKey
        EKSClusterName: !Ref EKSClusterName
        LoadBalancerEIP: !GetAtt DNSRecord.LoadBalancerEIP
        TMPServer: !Ref TMPServer
        TMPUsername: !Ref TMPUsername
        TMPPassword: !Ref TMPPassword