AWSTemplateFormatVersion: '2010-09-09'
Description: 'Oracle Database Template. (qs-1r4dcoii7)'
Metadata:
  cfn-lint: { config: { ignore_checks: [W9002, W9003, W9006] } }
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Amazon EC2 Configuration
        Parameters:
          - VPCID
      - Label:
          default: Oracle RDS Configuration
        Parameters:
          - ORAVersion
          - DBInstanceClass
          - DBInstanceIdentifier
          - DBName
          - DBUser
          - DBPassword
          - DBPort
          - DBMultiZone
    ParameterLabels:
      ORAVersion:
        default: Amazon RDS Oracle version
      DBInstanceClass:
        default: Amazon RDS instance type for the Oracle Database instance
      DBInstanceIdentifier:
        default: The database instance name
      DBName:
        default: The database name
      DBUser:
        default: The database admin account username
      DBPassword:
        default: The database admin account password
      DBPort:
        default: Oracle Database listener port number.
      DBMultiZone:
        default: High Availability (Multi-AZ) for Oracle RDS
      VPCID:
        default: VpcId of your Virtual Private Cloud (VPC)
Parameters:
  ORAVersion:
    AllowedValues:
      - Enterprise-Edition-12.2-BYOL
      - Enterprise-Edition-19.0-BYOL
      - Standard-Edition-Two-12.2-License-Included
      - Standard-Edition-Two-19.0-License-Included
    Default: Standard-Edition-Two-19.0-License-Included
    Description: Amazon RDS Oracle version
    Type: String
  DBInstanceClass:
    AllowedValues:
      - db.t3.micro
      - db.t3.small
      - db.t3.medium
      - db.m5.large
      - db.m5.xlarge
      - db.m5.2xlarge
      - db.m5.4xlarge
    Default: db.t3.medium
    Description: Amazon RDS instance type for the Oracle Database instance
    Type: String
  DBInstanceIdentifier:
    Default: ORCL
    Description: The database instance name
    Type: String
    MinLength: '1'
    MaxLength: '8'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters.
  DBName:
    Default: db3dec
    Description: The database name
    Type: String
    MinLength: '1'
    MaxLength: '8'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters.
  DBUser:
    Default: admin
    Description: The database admin account username
    Type: String
    MinLength: 1
    MaxLength: 16
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters.
  DBPassword:
    NoEcho: true
    Description: The database admin account password
    Type: String
    MinLength: 8
    MaxLength: 41
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: must contain only alphanumeric characters.
  DBPort:
    Default: 1521
    Description: Oracle Database listener port number.
    Type: Number
  DBMultiZone:
    Description: High Availability (Multi-AZ) for Oracle RDS.
        More informtion is available here - https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.MultiAZ.html
    Type: String
    AllowedValues:
      - true
      - false
    Default: true
  VPCID:
    Type: AWS::EC2::VPC::Id
    Description: VpcId of your Virtual Private Cloud (VPC)
Mappings:
  OracleDetailsMap:
    Enterprise-Edition-12.2-BYOL:
      Version: 12.2.0.1.ru-2021-01.rur-2021-01.r1
      Engine: oracle-ee
      Family: oracle-ee-12.2
      License: bring-your-own-license
    Enterprise-Edition-19.0-BYOL:
      Version: 19.0.0.0.ru-2021-04.rur-2021-04.r1
      Engine: oracle-ee
      Family: oracle-ee-19
      License: bring-your-own-license
    Standard-Edition-Two-12.2-License-Included:
      Version: 12.2.0.1.ru-2021-01.rur-2021-01.r1
      Engine: oracle-se2
      Family: oracle-se2-12.2
      License: license-included
    Standard-Edition-Two-19.0-License-Included:
      Version: 19.0.0.0.ru-2021-04.rur-2021-04.r1
      Engine: oracle-se2
      Family: oracle-se2-19
      License: license-included

Resources:
  EncryptionKey:
    Metadata:
      cfn-lint:
        config:
          ignore_checks:
            - EIAMPolicyActionWildcard
          ignore_reasons:
            EIAMPolicyActionWildcard: The first statement is the default key policy allowing administrators to administer the CMK. See https://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html#key-policy-default-allow-root-enable-iam.
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy:
        Version: 2012-10-17
        Id: !Ref AWS::StackName
        Statement:
          - Effect: Allow
            Principal:
              AWS:
                - !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:root"
            Action: 'kms:*'
            Resource: '*'
          - Effect: Allow
            Principal:
              AWS: '*'
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncryptTo
              - kms:ReEncryptFrom
              - kms:GenerateDataKeyWithoutPlaintext
              - kms:GenerateDataKey
              - kms:GenerateDataKeyPairWithoutPlaintext
              - kms:GenerateDataKeyPair
              - kms:CreateGrant
              - kms:ListGrants
              - kms:DescribeKey
            Resource: '*'
            Condition:
              StringEquals:
                kms:CallerAccount: !Ref AWS::AccountId
                kms:ViaService: !Sub "rds.${AWS::Region}.${AWS::URLSuffix}"
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
  EncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}"
      TargetKeyId: !Ref EncryptionKey
  OracleServersSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      VpcId: !Ref VPCID
      GroupDescription: Oracle inter-server communication and management ports
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref OracleServerSecurityGroup
        - IpProtocol: tcp
          FromPort: !Ref DBPort
          ToPort: !Ref DBPort
          SourceSecurityGroupId: !Ref OracleServerSecurityGroup
  PrimaryDBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      AllocatedStorage: '100'
      CharacterSetName: AL32UTF8
      DBInstanceClass: !Ref DBInstanceClass
      DBInstanceIdentifier: !Ref DBInstanceIdentifier
      DBName: !Ref DBName
      DBParameterGroupName: !Ref 'DBParamGroup'
      Engine: !FindInMap [OracleDetailsMap, !Ref ORAVersion, Engine]
      EngineVersion: !FindInMap [OracleDetailsMap, !Ref ORAVersion, Version]
      LicenseModel: !FindInMap [OracleDetailsMap, !Ref ORAVersion, License]
      MasterUsername: !Ref 'DBUser'
      MasterUserPassword: !Ref 'DBPassword'
      MultiAZ: !Ref 'DBMultiZone'
      StorageEncrypted: true
      StorageType: gp2
      KmsKeyId: !GetAtt EncryptionKey.Arn
  DBParamGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: Oracle Database Parameter Group
      Family: !FindInMap [OracleDetailsMap, !Ref ORAVersion, Family]
      Tags:
        - Key: Name
          Value: "DBParamGroup"
Outputs:
  PrimaryEndpointAddress:
    Description: Endpoint address for the primary database
    Value: !GetAtt 'PrimaryDBInstance.Endpoint.Address'
  PrimaryEndpointPort:
    Description: Endpoint port for the primary database
    Value: !GetAtt 'PrimaryDBInstance.Endpoint.Port'
  PrimaryJDBCConnectionString:
    Description: JDBC connection string for the primary database
    Value: !Join
      - ''
      - - 'jdbc:oracle:thin:@'
        - !GetAtt
          - PrimaryDBInstance
          - Endpoint.Address
        - ':'
        - !GetAtt
          - PrimaryDBInstance
          - Endpoint.Port
        - ':'
        - !Ref DBName